<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Manage Credentials - ECU Mock Oral</title>
    <link rel="stylesheet" href="/css/styles.css">
    <style>
        .credentials-print {
            font-family: 'Courier New', monospace;
        }
        .credentials-print table {
            width: 100%;
            border-collapse: collapse;
        }
        .credentials-print td {
            padding: 10px;
            border: 1px dashed #ccc;
            text-align: center;
        }
        @media print {
            body * { visibility: hidden; }
            .print-section, .print-section * { visibility: visible; }
            .print-section { position: absolute; left: 0; top: 0; width: 100%; }
        }
    </style>
</head>
<body>
    <header class="header no-print">
        <h1>ECU Mock Oral Platform</h1>
        <p class="subtitle">Credential Management</p>
    </header>

    <nav class="admin-nav no-print">
        <a href="/admin">Dashboard</a>
        <a href="/admin/repository">Repository</a>
        <a href="/admin/exams">Exams</a>
        <a href="/admin/credentials" class="active">Credentials</a>
        <a href="/admin/files">Exam Files</a>
        <a href="/admin/settings">Settings</a>
        <form action="/admin/logout" method="POST" style="margin-left: auto; display: inline;">
            <button type="submit" class="btn btn-secondary btn-sm">Logout</button>
        </form>
    </nav>

    <div class="container no-print">
        <div class="card">
            <h2 class="card-title">Select Exam</h2>
            <div class="form-group">
                <select id="exam-select" class="form-control">
                    <option value="">-- Select an exam --</option>
                </select>
            </div>
        </div>

        <div id="credentials-section" style="display: none;">
            <div class="card">
                <h2 class="card-title">Generate Credentials</h2>
                <form id="generate-form">
                    <div style="display: flex; gap: 15px; flex-wrap: wrap;">
                        <div class="form-group" style="flex: 1; min-width: 150px;">
                            <label for="count">Number to Generate</label>
                            <input type="number" id="count" class="form-control" min="1" max="100" value="10">
                        </div>
                        <div class="form-group" style="flex: 1; min-width: 150px;">
                            <label for="prefix">Username Prefix (optional)</label>
                            <input type="text" id="prefix" class="form-control" placeholder="e.g., RES">
                        </div>
                    </div>
                    <button type="submit" class="btn btn-success">Generate Credentials</button>
                </form>
            </div>

            <div class="card">
                <h2 class="card-title">Add Individual Credential</h2>
                <form id="add-form">
                    <div style="display: flex; gap: 15px; flex-wrap: wrap;">
                        <div class="form-group" style="flex: 1; min-width: 120px;">
                            <label for="new-username">Username</label>
                            <input type="text" id="new-username" class="form-control" required>
                        </div>
                        <div class="form-group" style="flex: 1; min-width: 120px;">
                            <label for="new-password">Password</label>
                            <input type="text" id="new-password" class="form-control" required>
                        </div>
                        <div class="form-group" style="flex: 1; min-width: 150px;">
                            <label for="new-name">Examinee Name (optional)</label>
                            <input type="text" id="new-name" class="form-control">
                        </div>
                    </div>
                    <button type="submit" class="btn btn-primary">Add Credential</button>
                </form>
            </div>

            <div class="card">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 10px;">
                    <h2 class="card-title" style="margin-bottom: 0; border: none; padding: 0;">
                        Credentials <span id="cred-stats"></span>
                    </h2>
                    <div style="display: flex; gap: 10px;">
                        <button class="btn btn-secondary btn-sm" onclick="printCredentials()">Print Credentials</button>
                        <button class="btn btn-danger btn-sm" onclick="deleteAllCredentials()">Delete All</button>
                    </div>
                </div>
                <div id="message" class="alert" style="display: none;"></div>
                <table class="table" id="credentials-table">
                    <thead>
                        <tr>
                            <th>Username</th>
                            <th>Password</th>
                            <th>Examinee</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td colspan="5" style="text-align: center; color: #888;">Select an exam to view credentials</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Edit Examinee Name Modal -->
    <div class="modal" id="edit-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Edit Examinee Name</h3>
                <button class="modal-close" onclick="closeEditModal()">&times;</button>
            </div>
            <form id="edit-name-form">
                <input type="hidden" id="edit-cred-id">
                <div class="form-group">
                    <label for="edit-examinee-name">Examinee Name</label>
                    <input type="text" id="edit-examinee-name" class="form-control" placeholder="Enter name (optional)">
                </div>
                <div style="display: flex; gap: 10px;">
                    <button type="submit" class="btn btn-primary">Save</button>
                    <button type="button" class="btn btn-secondary" onclick="closeEditModal()">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Print Section -->
    <div class="print-section" id="print-section" style="display: none;">
        <h2 style="text-align: center; margin-bottom: 20px;">Exam Credentials</h2>
        <p style="text-align: center; margin-bottom: 20px;" id="print-exam-name"></p>
        <div class="credentials-print" id="print-content"></div>
    </div>

    <script>
        let currentExamId = null;
        let currentCredentials = [];

        function showMessage(text, type) {
            const msg = document.getElementById('message');
            msg.textContent = text;
            msg.className = `alert alert-${type}`;
            msg.style.display = 'block';
            setTimeout(() => msg.style.display = 'none', 3000);
        }

        async function loadExams() {
            const response = await fetch('/admin/exams/list');
            const exams = await response.json();

            const select = document.getElementById('exam-select');
            select.innerHTML = '<option value="">-- Select an exam --</option>';

            exams.forEach(exam => {
                const option = document.createElement('option');
                option.value = exam.id;
                option.textContent = `${exam.name}${exam.is_active ? ' (Active)' : ''}`;
                select.appendChild(option);
            });
        }

        async function loadCredentials(examId) {
            const response = await fetch(`/admin/credentials/list/${examId}`);
            const data = await response.json();

            currentCredentials = data.credentials;

            document.getElementById('cred-stats').textContent = `(${data.used}/${data.total} used)`;

            const tbody = document.querySelector('#credentials-table tbody');

            if (data.credentials.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; color: #888;">No credentials yet. Generate some above.</td></tr>';
                return;
            }

            tbody.innerHTML = data.credentials.map(cred => `
                <tr>
                    <td><code>${cred.username}</code></td>
                    <td><code>${cred.password}</code></td>
                    <td>
                        ${cred.examinee_name || '<span style="color:#999">-</span>'}
                        <button class="btn btn-sm btn-secondary" style="margin-left: 8px; padding: 2px 6px; font-size: 0.75rem;" onclick="editExamineeName(${cred.id}, '${(cred.examinee_name || '').replace(/'/g, "\\'")}')">Edit</button>
                    </td>
                    <td>
                        ${cred.is_used
                            ? `<span class="badge badge-danger">Used</span><br><small>${new Date(cred.used_at).toLocaleString()}</small>`
                            : '<span class="badge badge-success">Available</span>'}
                    </td>
                    <td>
                        ${cred.is_used
                            ? `<button class="btn btn-sm btn-primary" onclick="resetCredential(${cred.id})">Reset</button>`
                            : ''}
                        <button class="btn btn-sm btn-danger" onclick="deleteCredential(${cred.id})">Delete</button>
                    </td>
                </tr>
            `).join('');
        }

        document.getElementById('exam-select').addEventListener('change', (e) => {
            currentExamId = e.target.value;
            if (currentExamId) {
                document.getElementById('credentials-section').style.display = 'block';
                loadCredentials(currentExamId);
            } else {
                document.getElementById('credentials-section').style.display = 'none';
            }
        });

        document.getElementById('generate-form').addEventListener('submit', async (e) => {
            e.preventDefault();

            const count = parseInt(document.getElementById('count').value);
            const prefix = document.getElementById('prefix').value.toUpperCase();

            try {
                const response = await fetch('/admin/credentials/generate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ examId: parseInt(currentExamId), count, prefix })
                });

                if (response.ok) {
                    const data = await response.json();
                    showMessage(`Generated ${data.generated.length} credentials!`, 'success');
                    loadCredentials(currentExamId);
                } else {
                    const data = await response.json();
                    showMessage(data.error || 'Failed to generate credentials', 'error');
                }
            } catch (err) {
                showMessage('An error occurred', 'error');
            }
        });

        document.getElementById('add-form').addEventListener('submit', async (e) => {
            e.preventDefault();

            const username = document.getElementById('new-username').value;
            const password = document.getElementById('new-password').value;
            const examineeName = document.getElementById('new-name').value;

            try {
                const response = await fetch('/admin/credentials', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        examId: parseInt(currentExamId),
                        username,
                        password,
                        examineeName
                    })
                });

                if (response.ok) {
                    showMessage('Credential added!', 'success');
                    document.getElementById('add-form').reset();
                    loadCredentials(currentExamId);
                } else {
                    const data = await response.json();
                    showMessage(data.error || 'Failed to add credential', 'error');
                }
            } catch (err) {
                showMessage('An error occurred', 'error');
            }
        });

        async function resetCredential(id) {
            if (!confirm('Reset this credential? It will be marked as unused.')) return;

            try {
                const response = await fetch(`/admin/credentials/${id}/reset`, { method: 'POST' });
                if (response.ok) {
                    showMessage('Credential reset!', 'success');
                    loadCredentials(currentExamId);
                }
            } catch (err) {
                showMessage('An error occurred', 'error');
            }
        }

        async function deleteCredential(id) {
            if (!confirm('Delete this credential?')) return;

            try {
                const response = await fetch(`/admin/credentials/${id}`, { method: 'DELETE' });
                if (response.ok) {
                    showMessage('Credential deleted!', 'success');
                    loadCredentials(currentExamId);
                } else {
                    const data = await response.json();
                    showMessage(data.error || 'Failed to delete', 'error');
                }
            } catch (err) {
                showMessage('An error occurred', 'error');
            }
        }

        async function deleteAllCredentials() {
            if (!confirm('Delete ALL credentials for this exam? This cannot be undone.')) return;
            if (!confirm('Are you sure? This will delete ' + currentCredentials.length + ' credentials.')) return;

            try {
                const response = await fetch(`/admin/credentials/exam/${currentExamId}`, { method: 'DELETE' });
                if (response.ok) {
                    showMessage('All credentials deleted!', 'success');
                    loadCredentials(currentExamId);
                } else {
                    const data = await response.json();
                    showMessage(data.error || 'Failed to delete', 'error');
                }
            } catch (err) {
                showMessage('An error occurred', 'error');
            }
        }

        function editExamineeName(id, currentName) {
            document.getElementById('edit-cred-id').value = id;
            document.getElementById('edit-examinee-name').value = currentName;
            document.getElementById('edit-modal').classList.add('active');
        }

        function closeEditModal() {
            document.getElementById('edit-modal').classList.remove('active');
        }

        document.getElementById('edit-name-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const id = document.getElementById('edit-cred-id').value;
            const examineeName = document.getElementById('edit-examinee-name').value;

            try {
                const response = await fetch(`/admin/credentials/${id}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ examineeName })
                });

                if (response.ok) {
                    showMessage('Name updated!', 'success');
                    closeEditModal();
                    loadCredentials(currentExamId);
                } else {
                    const data = await response.json();
                    showMessage(data.error || 'Failed to update', 'error');
                }
            } catch (err) {
                showMessage('An error occurred', 'error');
            }
        });

        // Close modal on outside click
        document.getElementById('edit-modal').addEventListener('click', (e) => {
            if (e.target.classList.contains('modal')) {
                closeEditModal();
            }
        });

        function printCredentials() {
            const examSelect = document.getElementById('exam-select');
            const examName = examSelect.options[examSelect.selectedIndex].textContent;

            document.getElementById('print-exam-name').textContent = examName;

            // Generate printable credential cards
            let html = '<table>';
            currentCredentials.filter(c => !c.is_used).forEach((cred, i) => {
                if (i % 2 === 0) html += '<tr>';
                html += `
                    <td style="width: 50%; padding: 20px;">
                        <div style="border: 2px solid #333; padding: 15px; text-align: center;">
                            <strong style="font-size: 1.2em;">ECU Mock Oral Exam</strong><br><br>
                            <div style="margin: 10px 0;">
                                <strong>Username:</strong> <span style="font-size: 1.3em;">${cred.username}</span>
                            </div>
                            <div style="margin: 10px 0;">
                                <strong>Password:</strong> <span style="font-size: 1.3em;">${cred.password}</span>
                            </div>
                            ${cred.examinee_name ? `<div style="margin-top: 10px; color: #666;">${cred.examinee_name}</div>` : ''}
                        </div>
                    </td>
                `;
                if (i % 2 === 1) html += '</tr>';
            });
            if (currentCredentials.filter(c => !c.is_used).length % 2 === 1) html += '<td></td></tr>';
            html += '</table>';

            document.getElementById('print-content').innerHTML = html;
            document.getElementById('print-section').style.display = 'block';
            window.print();
            document.getElementById('print-section').style.display = 'none';
        }

        loadExams();
    </script>
</body>
</html>
